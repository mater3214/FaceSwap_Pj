<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FaceLab Hub</title>
  <style>
    :root {
      --bg-primary: #0b0f17;
      --bg-secondary: #121a2a;
      --bg-tertiary: #0f1626;
      --bg-quaternary: #08111b;
      --border-primary: #222e46;
      --border-secondary: #26324d;
      --border-tertiary: #2a3550;
      --border-light: #2b3856;
      --text-primary: #e7eefc;
      --text-secondary: #a9b6d6;
      --text-tertiary: #95a4c9;
      --text-light: #b8c7ff;
      --text-highlight: #c6d3ff;
      --accent-primary: #6aa1ff;
      --accent-bg: #1a2e55;
      --shadow-primary: rgba(0,0,0,0.35);
      --spacing-xs: 6px;
      --spacing-sm: 10px;
      --spacing-md: 14px;
      --spacing-lg: 18px;
      --spacing-xl: 22px;
      --border-radius-sm: 8px;
      --border-radius-md: 12px;
      --border-radius-lg: 16px;
      --font-xs: 12px;
      --font-sm: 13px;
      --font-md: 14px;
      --font-lg: 22px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Arial', sans-serif;
      margin: 0;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
    }

    .wrap {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px var(--spacing-lg) 60px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-md);
      padding-bottom: var(--spacing-lg);
      border-bottom: 1px solid var(--border-secondary);
      margin-bottom: var(--spacing-lg);
    }

    .brand {
      font-size: var(--font-lg);
      font-weight: 700;
      color: var(--accent-primary);
    }

    .tag {
      font-size: var(--font-xs);
      padding: var(--spacing-xs) var(--spacing-sm);
      border: 1px solid var(--border-tertiary);
      border-radius: 999px;
      color: var(--text-light);
      background: var(--bg-secondary);
    }

    .grid {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: var(--spacing-lg);
    }

    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      box-shadow: 0 4px 12px var(--shadow-primary);
    }

    .title {
      font-size: var(--font-md);
      color: var(--text-secondary);
      margin: 0 0 var(--spacing-md);
      font-weight: 600;
    }

    .menu {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      margin-bottom: var(--spacing-md);
    }

    .menu button {
      width: 100%;
      text-align: left;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--border-radius-md);
      border: 1px solid var(--border-secondary);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      cursor: pointer;
      font-size: var(--font-sm);
      transition: all 0.2s ease;
    }

    .menu button:hover:not(:disabled):not(.active) {
      border-color: var(--border-light);
      background: rgba(15, 22, 38, 0.8);
    }

    .menu button.active {
      border-color: var(--accent-primary);
      background: var(--accent-bg);
      box-shadow: 0 0 0 2px rgba(106, 161, 255, 0.15);
    }

    .menu button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-lg);
    }

    .box {
      border: 1px dashed var(--border-light);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      background: var(--bg-tertiary);
      grid-column: span 2;
    }

    label {
      font-size: var(--font-xs);
      color: var(--text-secondary);
      display: block;
      margin-bottom: var(--spacing-xs);
      font-weight: 500;
    }

    input[type="file"] {
      width: 100%;
      padding: var(--spacing-sm);
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--border-secondary);
      background: var(--bg-quaternary);
      color: var(--text-primary);
      font-size: var(--font-sm);
      cursor: pointer;
      transition: border-color 0.2s ease;
    }

    input[type="file"]:hover {
      border-color: var(--border-light);
    }

    input[type="file"]:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    .actions {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
    }

    .btn {
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--border-radius-md);
      border: 1px solid var(--border-tertiary);
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor: pointer;
      font-size: var(--font-sm);
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .btn:hover:not(:disabled) {
      background: #1d2a44;
      border-color: var(--border-light);
    }

    .btn.primary {
      border-color: var(--accent-primary);
      background: var(--accent-bg);
    }

    .btn.primary:hover:not(:disabled) {
      background: #214099;
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .status {
      margin-top: var(--spacing-md);
      font-size: var(--font-sm);
      color: var(--text-highlight);
      min-height: 18px;
      padding: var(--spacing-xs);
      border-radius: var(--border-radius-sm);
    }

    .note {
      font-size: var(--font-xs);
      color: var(--text-tertiary);
      line-height: 1.45;
      margin-top: var(--spacing-md);
      padding: var(--spacing-sm);
      background: rgba(8, 17, 27, 0.4);
      border-radius: var(--border-radius-sm);
    }

    .thumbs {
      display: flex;
      gap: var(--spacing-xs);
      flex-wrap: wrap;
      margin-top: var(--spacing-sm);
    }

    .thumb {
      width: 84px;
      height: 84px;
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      border: 1px solid var(--border-secondary);
      background: var(--bg-quaternary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }

    .thumb:hover {
      transform: translateY(-2px);
      border-color: var(--border-light);
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .compare {
      display: flex;
      gap: var(--spacing-xl);
      margin-top: var(--spacing-lg);
      align-items: stretch;
    }

    .compare .pane {
      flex: 1;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-secondary);
      padding: var(--spacing-md);
      border-radius: var(--border-radius-md);
      min-height: 400px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 6px 18px var(--shadow-primary);
    }

    .compare .pane-header {
      font-size: var(--font-sm);
      color: var(--text-tertiary);
      margin-bottom: var(--spacing-sm);
      font-weight: 500;
    }

    .compare .pane-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-radius: var(--border-radius-sm);
      background: var(--bg-quaternary);
    }

    .compare .pane-content img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: var(--border-radius-sm);
      display: block;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.12);
      border-top-color: var(--accent-primary);
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: var(--spacing-xs);
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .file-info {
      font-size: var(--font-xs);
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    /* Background Removal Styles */
    .color-picker-section {
      margin-top: var(--spacing-md);
    }

    .preset-colors {
      display: flex;
      gap: var(--spacing-xs);
      flex-wrap: wrap;
      margin-top: var(--spacing-sm);
    }

    .color-btn {
      width: 40px;
      height: 40px;
      border-radius: var(--border-radius-sm);
      border: 2px solid var(--border-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .color-btn:hover {
      border-color: var(--accent-primary);
      transform: scale(1.1);
    }

    .color-btn.selected {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(106, 161, 255, 0.3);
    }

    .custom-color {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
      align-items: center;
    }

    .custom-color input[type="color"] {
      width: 50px;
      height: 40px;
      border: 2px solid var(--border-secondary);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      background: transparent;
    }

    .selected-colors {
      display: flex;
      gap: var(--spacing-xs);
      flex-wrap: wrap;
      margin-top: var(--spacing-sm);
    }

    .color-tag {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--border-secondary);
      background: var(--bg-quaternary);
      font-size: var(--font-xs);
    }

    .color-tag .color-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid var(--border-light);
    }

    .color-tag .remove-color {
      cursor: pointer;
      color: var(--text-tertiary);
      margin-left: var(--spacing-xs);
    }

    .color-tag .remove-color:hover {
      color: #ff6b6b;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: var(--spacing-md);
      margin-top: var(--spacing-lg);
    }

    .result-item {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-secondary);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-md);
      text-align: center;
    }

    .result-item img {
      width: 100%;
      border-radius: var(--border-radius-sm);
      margin-bottom: var(--spacing-sm);
    }

    .result-item .color-label {
      font-size: var(--font-xs);
      color: var(--text-tertiary);
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .row {
        grid-template-columns: 1fr;
      }
      
      .compare {
        flex-direction: column;
        gap: var(--spacing-lg);
      }
      
      .compare .pane {
        min-height: 350px;
      }
    }

    @media (max-width: 768px) {
      .wrap {
        padding: 15px 12px 40px;
      }
      
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-sm);
      }
      
      .box {
        padding: var(--spacing-md);
      }
      
      .actions {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">FaceLab Hub</div>
      <div class="tag">AI for face editing • modular services</div>
    </div>

    <div class="grid">
      <!-- Left: Hub menu -->
      <div class="card">
        <p class="title">Tools</p>
        <div class="menu">
          <button id="tool-simswap" class="active">✅ SimSwap (Face Swap)</button>
          <button id="tool-simswap-multi">✅ SimSwap (Multi Face Swap)</button>
          <button id="tool-bg-removal">✅ Background Removal</button>
          <button disabled>⏳ DiFaReLi (Relighting) — coming soon</button>
        </div>
        <p class="note">
          * SimSwap and Background Removal available<br/>
          * New tools can be added via API Gateway later
        </p>
      </div>

      <!-- Right: Tool panel -->
      <div class="card">
        <p class="title" id="tool-title">SimSwap (Single Face)</p>

        <div class="row">
          <div class="box">
            <!-- Single face panel -->
            <div id="panel-single" class="panel active">
              <label>Source face (src)</label>
              <input id="src_single" type="file" accept="image/*" />
              <div class="file-info">Select one source face image</div>
              <div id="thumbs_single" class="thumbs"></div>
              
              <label style="margin-top: var(--spacing-md);">Target image (dst)</label>
              <input id="dst_single" type="file" accept="image/*" />
              <div class="file-info">Select one target image</div>
              <div id="thumb_dst_single" class="thumbs"></div>
              
              <div class="actions">
                <button id="run_single" class="btn primary">Run Single Swap</button>
                <button id="clear_single" class="btn">Clear All</button>
              </div>
              
              <div id="status_single" class="status"></div>
              
              <div class="compare" id="compare_single" style="display:none;">
                <div class="pane">
                  <div class="pane-header">Before (Target)</div>
                  <div class="pane-content">
                    <img id="before_single" />
                  </div>
                </div>
                <div class="pane">
                  <div class="pane-header">After (Result)</div>
                  <div class="pane-content">
                    <img id="outimg_single" alt="Result will appear here" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Multi face panel -->
            <div id="panel-multi" class="panel">
              <label>Source faces (src) — multiple</label>
              <input id="src_multi" type="file" accept="image/*" multiple />
              <div class="file-info">Select multiple source faces (ctrl/cmd+click)</div>
              <div id="thumbs_multi" class="thumbs"></div>
              
              <label style="margin-top: var(--spacing-md);">Target image (dst)</label>
              <input id="dst_multi" type="file" accept="image/*" />
              <div class="file-info">Select one target image</div>
              <div id="thumb_dst_multi" class="thumbs"></div>
              
              <div class="actions">
                <button id="run_multi_btn" class="btn primary">Run Multi Swap</button>
                <button id="clear_multi" class="btn">Clear All</button>
              </div>
              
              <div id="status_multi" class="status"></div>
              
              <div class="compare" id="compare_multi" style="display:none;">
                <div class="pane">
                  <div class="pane-header">Before (Target)</div>
                  <div class="pane-content">
                    <img id="before_multi" />
                  </div>
                </div>
                <div class="pane">
                  <div class="pane-header">After (Result)</div>
                  <div class="pane-content">
                    <img id="outimg_multi" alt="Result will appear here" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Background Removal panel -->
            <div id="panel-bg-removal" class="panel">
              <label>Upload image</label>
              <input id="bg_image" type="file" accept="image/*" />
              <div class="file-info">Select an image to remove background</div>
              <div id="thumb_bg" class="thumbs"></div>

              <div class="color-picker-section">
                <label>Select background colors</label>
                <div class="preset-colors">
                  <button class="color-btn" data-color="255,255,255" style="background: #ffffff;" title="White"></button>
                  <button class="color-btn" data-color="0,0,0" style="background: #000000;" title="Black"></button>
                  <button class="color-btn" data-color="255,0,0" style="background: #ff0000;" title="Red"></button>
                  <button class="color-btn" data-color="0,255,0" style="background: #00ff00;" title="Green"></button>
                  <button class="color-btn" data-color="0,0,255" style="background: #0000ff;" title="Blue"></button>
                  <button class="color-btn" data-color="255,255,0" style="background: #ffff00;" title="Yellow"></button>
                  <button class="color-btn" data-color="255,0,255" style="background: #ff00ff;" title="Magenta"></button>
                  <button class="color-btn" data-color="0,255,255" style="background: #00ffff;" title="Cyan"></button>
                  <button class="color-btn" data-color="255,128,0" style="background: #ff8000;" title="Orange"></button>
                  <button class="color-btn" data-color="128,0,255" style="background: #8000ff;" title="Purple"></button>
                  <button class="color-btn" data-color="128,128,128" style="background: #808080;" title="Gray"></button>
                  <button class="color-btn" data-color="255,192,203" style="background: #ffc0cb;" title="Pink"></button>
                </div>

                <div class="custom-color">
                  <input type="color" id="custom_color_picker" value="#000000" />
                  <button id="add_custom_color" class="btn">Add Custom Color</button>
                </div>

                <div class="selected-colors" id="selected_colors"></div>
              </div>
              
              <div class="actions">
                <button id="run_bg_removal" class="btn primary">Remove Background</button>
                <button id="clear_bg" class="btn">Clear All</button>
              </div>
              
              <div id="status_bg" class="status"></div>
              
              <div class="compare" id="compare_bg" style="display:none;">
                <div class="pane">
                  <div class="pane-header">Before</div>
                  <div class="pane-content">
                    <img id="before_bg" />
                  </div>
                </div>
                <div class="pane">
                  <div class="pane-header">After (Result)</div>
                  <div class="pane-content">
                    <img id="outimg_bg" alt="Result will appear here" />
                  </div>
                </div>
              </div>

              <div class="results-grid" id="results_grid" style="display:none;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const toolSingleBtn = document.getElementById("tool-simswap");
  const toolMultiBtn = document.getElementById("tool-simswap-multi");
  const toolBgRemovalBtn = document.getElementById("tool-bg-removal");
  const toolTitle = document.getElementById("tool-title");

  // Single elements
  const srcSingle = document.getElementById("src_single");
  const dstSingle = document.getElementById("dst_single");
  const runSingle = document.getElementById("run_single");
  const clearSingle = document.getElementById("clear_single");
  const statusSingle = document.getElementById("status_single");
  const outImgSingle = document.getElementById("outimg_single");

  // Multi elements
  const srcMulti = document.getElementById("src_multi");
  const dstMulti = document.getElementById("dst_multi");
  const runMultiBtn = document.getElementById("run_multi_btn");
  const clearMulti = document.getElementById("clear_multi");
  const statusMulti = document.getElementById("status_multi");
  const outImgMulti = document.getElementById("outimg_multi");

  // Background Removal elements
  const bgImage = document.getElementById("bg_image");
  const runBgRemoval = document.getElementById("run_bg_removal");
  const clearBg = document.getElementById("clear_bg");
  const statusBg = document.getElementById("status_bg");
  const outImgBg = document.getElementById("outimg_bg");
  const selectedColorsDiv = document.getElementById("selected_colors");
  const customColorPicker = document.getElementById("custom_color_picker");
  const addCustomColorBtn = document.getElementById("add_custom_color");
  const presetColorBtns = document.querySelectorAll(".color-btn");
  let selectedColors = [];

  function clearSinglePanel() {
    srcSingle.value = "";
    dstSingle.value = "";
    document.getElementById("thumbs_single").innerHTML = "";
    document.getElementById("thumb_dst_single").innerHTML = "";
    outImgSingle.src = "";
    document.getElementById("before_single").src = "";
    document.getElementById("compare_single").style.display = "none";
    statusSingle.textContent = "";
  }

  function clearMultiPanel() {
    srcMulti.value = "";
    dstMulti.value = "";
    document.getElementById("thumbs_multi").innerHTML = "";
    document.getElementById("thumb_dst_multi").innerHTML = "";
    outImgMulti.src = "";
    document.getElementById("before_multi").src = "";
    document.getElementById("compare_multi").style.display = "none";
    statusMulti.textContent = "";
  }

  clearSingle.onclick = clearSinglePanel;
  clearMulti.onclick = clearMultiPanel;

  function setActiveTool(tool) {
    // Reset all
    toolSingleBtn.classList.remove('active');
    toolMultiBtn.classList.remove('active');
    toolBgRemovalBtn.classList.remove('active');
    document.getElementById('panel-single').classList.remove('active');
    document.getElementById('panel-multi').classList.remove('active');
    document.getElementById('panel-bg-removal').classList.remove('active');

    if (tool === 'single') {
      toolSingleBtn.classList.add('active');
      document.getElementById('panel-single').classList.add('active');
      toolTitle.textContent = 'SimSwap (Single Face)';
    } else if (tool === 'multi') {
      toolMultiBtn.classList.add('active');
      document.getElementById('panel-multi').classList.add('active');
      toolTitle.textContent = 'SimSwap (Multi Face)';
    } else if (tool === 'bg-removal') {
      toolBgRemovalBtn.classList.add('active');
      document.getElementById('panel-bg-removal').classList.add('active');
      toolTitle.textContent = 'Background Removal';
    }
  }

  toolSingleBtn.onclick = () => setActiveTool('single');
  toolMultiBtn.onclick = () => setActiveTool('multi');
  toolBgRemovalBtn.onclick = () => setActiveTool('bg-removal');

  runSingle.onclick = async () => {
    if (!srcSingle.files[0] || !dstSingle.files[0]) {
      statusSingle.textContent = 'Please select source and target images.';
      statusSingle.style.color = '#ff6b6b';
      return;
    }
    
    runSingle.disabled = true;
    statusSingle.style.color = 'var(--text-highlight)';
    statusSingle.innerHTML = '<span class="spinner"></span> Running SimSwap (single)...';
    
    const fd = new FormData();
    fd.append('src', srcSingle.files[0]);
    fd.append('dst', dstSingle.files[0]);
    
    try {
      const res = await fetch('/api/simswap', { method: 'POST', body: fd });
      const data = await res.json();
      
      if (!res.ok || !data.ok) {
        statusSingle.textContent = 'Error: ' + (data.detail || 'Unknown error');
        statusSingle.style.color = '#ff6b6b';
        return;
      }
      
      // Show before/after comparison
      const beforeUrl = URL.createObjectURL(dstSingle.files[0]);
      document.getElementById('before_single').src = beforeUrl;
      outImgSingle.src = data.result_url + '?t=' + Date.now();
      document.getElementById('compare_single').style.display = 'flex';
      statusSingle.textContent = 'Success! Swap completed.';
      statusSingle.style.color = '#6bff8d';
      
    } catch (e) {
      statusSingle.textContent = 'Request failed: ' + e.message;
      statusSingle.style.color = '#ff6b6b';
    } finally {
      runSingle.disabled = false;
    }
  };

  runMultiBtn.onclick = async () => {
    if (!srcMulti.files.length || !dstMulti.files[0]) {
      statusMulti.textContent = 'Please select source(s) and a target image.';
      statusMulti.style.color = '#ff6b6b';
      return;
    }
    
    runMultiBtn.disabled = true;
    statusMulti.style.color = 'var(--text-highlight)';
    statusMulti.innerHTML = '<span class="spinner"></span> Running SimSwap (multi)...';
    
    const fd = new FormData();
    for (let i = 0; i < srcMulti.files.length; i++) {
      fd.append('src', srcMulti.files[i]);
    }
    fd.append('dst', dstMulti.files[0]);
    
    try {
      const res = await fetch('/api/simswap_multi_upload', { method: 'POST', body: fd });
      const data = await res.json();
      
      if (!res.ok || !data.ok) {
        statusMulti.textContent = 'Error: ' + (data.detail || 'Unknown error');
        statusMulti.style.color = '#ff6b6b';
        return;
      }
      
      // Show before/after comparison
      const beforeUrl = URL.createObjectURL(dstMulti.files[0]);
      document.getElementById('before_multi').src = beforeUrl;
      outImgMulti.src = data.result_url + '?t=' + Date.now();
      document.getElementById('compare_multi').style.display = 'flex';
      statusMulti.textContent = 'Success! Multi swap completed.';
      statusMulti.style.color = '#6bff8d';
      
    } catch (e) {
      statusMulti.textContent = 'Request failed: ' + e.message;
      statusMulti.style.color = '#ff6b6b';
    } finally {
      runMultiBtn.disabled = false;
    }
  };

  // Render previews for selected files
  function addThumb(container, file) {
    const div = document.createElement('div');
    div.className = 'thumb';
    
    const img = document.createElement('img');
    div.appendChild(img);
    
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    reader.readAsDataURL(file);
    
    container.appendChild(div);
  }

  srcSingle.onchange = () => {
    const cont = document.getElementById('thumbs_single');
    cont.innerHTML = '';
    if (srcSingle.files[0]) addThumb(cont, srcSingle.files[0]);
  };
  
  dstSingle.onchange = () => {
    const cont = document.getElementById('thumb_dst_single');
    cont.innerHTML = '';
    if (dstSingle.files[0]) addThumb(cont, dstSingle.files[0]);
  };
  
  srcMulti.onchange = () => {
    const cont = document.getElementById('thumbs_multi');
    cont.innerHTML = '';
    for (let i = 0; i < srcMulti.files.length; i++) {
      addThumb(cont, srcMulti.files[i]);
    }
  };
  
  dstMulti.onchange = () => {
    const cont = document.getElementById('thumb_dst_multi');
    cont.innerHTML = '';
    if (dstMulti.files[0]) addThumb(cont, dstMulti.files[0]);
  };

  // Background Removal functions
  function rgbToRgbString(hex) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `${r},${g},${b}`;
  }

  function addColor(colorStr) {
    if (!selectedColors.includes(colorStr)) {
      selectedColors.push(colorStr);
      updateSelectedColorsDisplay();
      updatePresetButtons();
    }
  }

  function removeColor(colorStr) {
    selectedColors = selectedColors.filter(c => c !== colorStr);
    updateSelectedColorsDisplay();
    updatePresetButtons();
  }

  function updateSelectedColorsDisplay() {
    selectedColorsDiv.innerHTML = '';
    selectedColors.forEach(colorStr => {
      const [r, g, b] = colorStr.split(',').map(Number);
      const tag = document.createElement('div');
      tag.className = 'color-tag';
      tag.innerHTML = `
        <span class="color-dot" style="background: rgb(${r},${g},${b});"></span>
        <span>RGB(${r},${g},${b})</span>
        <span class="remove-color" data-color="${colorStr}">×</span>
      `;
      tag.querySelector('.remove-color').onclick = () => removeColor(colorStr);
      selectedColorsDiv.appendChild(tag);
    });
  }

  function updatePresetButtons() {
    presetColorBtns.forEach(btn => {
      const colorStr = btn.dataset.color;
      if (selectedColors.includes(colorStr)) {
        btn.classList.add('selected');
      } else {
        btn.classList.remove('selected');
      }
    });
  }

  function clearBgPanel() {
    bgImage.value = "";
    document.getElementById('thumb_bg').innerHTML = '';
    outImgBg.src = "";
    document.getElementById('before_bg').src = "";
    document.getElementById('compare_bg').style.display = 'none';
    document.getElementById('results_grid').style.display = 'none';
    document.getElementById('results_grid').innerHTML = '';
    statusBg.textContent = "";
    selectedColors = [];
    updateSelectedColorsDisplay();
    updatePresetButtons();
  }

  clearBg.onclick = clearBgPanel;

  presetColorBtns.forEach(btn => {
    btn.onclick = () => {
      const colorStr = btn.dataset.color;
      if (selectedColors.includes(colorStr)) {
        removeColor(colorStr);
      } else {
        addColor(colorStr);
      }
    };
  });

  addCustomColorBtn.onclick = () => {
    const hex = customColorPicker.value;
    const colorStr = rgbToRgbString(hex);
    addColor(colorStr);
  };

  bgImage.onchange = () => {
    const cont = document.getElementById('thumb_bg');
    cont.innerHTML = '';
    if (bgImage.files[0]) addThumb(cont, bgImage.files[0]);
  };

  runBgRemoval.onclick = async () => {
    if (!bgImage.files[0]) {
      statusBg.textContent = 'Please select an image.';
      statusBg.style.color = '#ff6b6b';
      return;
    }

    if (selectedColors.length === 0) {
      statusBg.textContent = 'Please select at least one background color.';
      statusBg.style.color = '#ff6b6b';
      return;
    }
    
    runBgRemoval.disabled = true;
    statusBg.style.color = 'var(--text-highlight)';
    statusBg.innerHTML = '<span class="spinner"></span> Processing background removal...';
    
    const fd = new FormData();
    fd.append('image', bgImage.files[0]);
    fd.append('colors', selectedColors.join('|'));
    
    try {
      const res = await fetch('/api/background_removal', { method: 'POST', body: fd });
      const data = await res.json();
      
      if (!res.ok || !data.ok) {
        statusBg.textContent = 'Error: ' + (data.detail || 'Unknown error');
        statusBg.style.color = '#ff6b6b';
        return;
      }
      
      console.log('Background removal response:', data);
      
      // Show before image
      const beforeUrl = URL.createObjectURL(bgImage.files[0]);
      document.getElementById('before_bg').src = beforeUrl;
      
      // Display results
      if (data.results && data.results.length > 0) {
        const results = data.results;
        
        if (results.length === 1) {
          // Single result: show before/after comparison
          document.getElementById('compare_bg').style.display = 'flex';
          document.getElementById('results_grid').style.display = 'none';
          
          const imgUrl = (results && results.length > 0) ? results[0] + '?t=' + Date.now() : '';
          if (!imgUrl) {
            statusBg.textContent = 'Error: No result URL returned';
            statusBg.style.color = '#ff6b6b';
            return;
          }
          console.log('Loading single result image:', imgUrl);
          
          const img = document.getElementById('outimg_bg');
          img.onerror = function() {
            console.error('Failed to load image:', imgUrl);
            statusBg.textContent = 'Error: Failed to load result image';
            statusBg.style.color = '#ff6b6b';
          };
          img.onload = function() {
            console.log('Image loaded successfully:', imgUrl);
          };
          img.src = imgUrl;
        } else {
          // Multiple results: show grid
          document.getElementById('compare_bg').style.display = 'none';
          document.getElementById('results_grid').style.display = 'grid';
          
          const grid = document.getElementById('results_grid');
          grid.innerHTML = '';
          
          results.forEach((resultUrl, index) => {
            const item = document.createElement('div');
            item.className = 'result-item';
            const color = (data.colors_used && data.colors_used[index]) ? data.colors_used[index] : { r: 0, g: 0, b: 0 };
            
            const imgUrl = resultUrl + '?t=' + Date.now();
            console.log('Loading result image:', imgUrl);
            
            const img = document.createElement('img');
            img.onerror = function() {
              console.error('Failed to load image:', imgUrl);
            };
            img.onload = function() {
              console.log('Image loaded successfully:', imgUrl);
            };
            img.src = imgUrl;
            
            item.appendChild(img);
            const label = document.createElement('div');
            label.className = 'color-label';
            label.textContent = `RGB(${color.r}, ${color.g}, ${color.b})`;
            item.appendChild(label);
            
            grid.appendChild(item);
          });
        }
        
        statusBg.textContent = `Success! Generated ${results.length} result(s).`;
        statusBg.style.color = '#6bff8d';
      } else {
        statusBg.textContent = 'No results returned.';
        statusBg.style.color = '#ff6b6b';
      }
      
    } catch (e) {
      console.error('Background removal error:', e);
      statusBg.textContent = 'Request failed: ' + e.message;
      statusBg.style.color = '#ff6b6b';
    } finally {
      runBgRemoval.disabled = false;
    }
  };
</script>
</body>
</html>
