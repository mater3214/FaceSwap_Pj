<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FaceLab Hub - AI Tools</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0b0f17;
      --bg-secondary: #121a2a;
      --bg-tertiary: #0f1626;
      --bg-quaternary: #08111b;
      --border-primary: #222e46;
      --border-secondary: #26324d;
      --border-tertiary: #2a3550;
      --border-light: #2b3856;
      --text-primary: #e7eefc;
      --text-secondary: #a9b6d6;
      --text-tertiary: #95a4c9;
      --text-light: #b8c7ff;
      --text-highlight: #c6d3ff;
      --accent-primary: #6aa1ff;
      --accent-bg: #1a2e55;
      --shadow-primary: rgba(0, 0, 0, 0.35);
      --spacing-xs: 6px;
      --spacing-sm: 10px;
      --spacing-md: 14px;
      --spacing-lg: 18px;
      --spacing-xl: 22px;
      --border-radius-sm: 8px;
      --border-radius-md: 12px;
      --border-radius-lg: 16px;
      --font-xs: 12px;
      --font-sm: 13px;
      --font-md: 14px;
      --font-lg: 22px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
    }

    .wrap {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px var(--spacing-lg) 60px;
    }

    /* --- HEADER --- */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: var(--spacing-lg);
      border-bottom: 1px solid var(--border-secondary);
      margin-bottom: var(--spacing-lg);
    }

    .brand {
      font-size: var(--font-lg);
      font-weight: 700;
      color: var(--accent-primary);
    }

    .tag {
      font-size: var(--font-xs);
      padding: 4px 12px;
      border: 1px solid var(--border-tertiary);
      border-radius: 99px;
      background: var(--bg-secondary);
      color: var(--text-light);
    }

    /* --- LAYOUT --- */
    .grid {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: var(--spacing-lg);
    }

    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      box-shadow: 0 4px 12px var(--shadow-primary);
    }

    /* --- MENU --- */
    .title {
      font-size: var(--font-md);
      color: var(--text-secondary);
      margin: 0 0 var(--spacing-md);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .menu button {
      width: 100%;
      text-align: left;
      padding: 12px 16px;
      border-radius: var(--border-radius-md);
      border: 1px solid var(--border-secondary);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      cursor: pointer;
      font-size: var(--font-sm);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .menu button:hover:not(:disabled):not(.active) {
      border-color: var(--border-light);
      background: rgba(15, 22, 38, 0.8);
    }

    .menu button.active {
      border-color: var(--accent-primary);
      background: var(--accent-bg);
      color: #fff;
      box-shadow: 0 0 0 1px rgba(106, 161, 255, 0.3);
    }

    .menu button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* --- FORMS & INPUTS --- */
    .box {
      border: 1px dashed var(--border-light);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      background: var(--bg-tertiary);
    }

    label {
      font-size: var(--font-xs);
      color: var(--text-secondary);
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
    }

    input[type="file"] {
      width: 100%;
      padding: 10px;
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--border-secondary);
      background: var(--bg-quaternary);
      color: var(--text-primary);
      font-size: var(--font-sm);
      cursor: pointer;
    }

    input[type="file"]::file-selector-button {
      background: var(--bg-secondary);
      border: 1px solid var(--border-tertiary);
      color: var(--text-light);
      padding: 4px 8px;
      border-radius: 4px;
      margin-right: 10px;
      cursor: pointer;
    }

    /* --- ACTIONS --- */
    .actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: var(--border-radius-md);
      border: 1px solid var(--border-tertiary);
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor: pointer;
      font-size: var(--font-sm);
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn:hover:not(:disabled) {
      background: #1d2a44;
      border-color: var(--border-light);
    }

    .btn.primary {
      border-color: var(--accent-primary);
      background: var(--accent-bg);
    }

    .btn.primary:hover:not(:disabled) {
      background: #214099;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: wait;
    }

    /* --- STATUS & RESULTS --- */
    .status {
      margin-top: 15px;
      font-size: var(--font-sm);
      min-height: 20px;
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .thumbs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
      min-height: 10px;
    }

    .thumb {
      width: 70px;
      height: 70px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border-secondary);
      background: #000;
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Compare View (Before/After) */
    .compare {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      align-items: stretch;
    }

    .pane {
      flex: 1;
      background: var(--bg-quaternary);
      border: 1px solid var(--border-secondary);
      padding: 10px;
      border-radius: 12px;
      text-align: center;
    }

    .pane-header {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-bottom: 8px;
    }

    .pane img {
      max-width: 100%;
      max-height: 400px;
      border-radius: 6px;
      object-fit: contain;
    }

    /* Grid View (Multiple Results) */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .result-item {
      background: var(--bg-quaternary);
      border: 1px solid var(--border-secondary);
      padding: 10px;
      border-radius: 10px;
      text-align: center;
    }

    .result-item img {
      width: 100%;
      border-radius: 6px;
      margin-bottom: 5px;
    }

    .result-label {
      font-size: 11px;
      color: var(--text-tertiary);
    }

    /* --- PANELS VISIBILITY --- */
    .panel {
      display: none;
    }

    .panel.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* --- BACKGROUND REMOVAL SPECIFIC UI --- */
    .mode-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 15px 0 25px;
      background: var(--bg-quaternary);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid var(--border-secondary);
    }

    .mode-selector label {
      margin: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .mode-selector label:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .mode-selector label:has(input:checked) {
      background: rgba(106, 161, 255, 0.15);
      border-color: var(--accent-primary);
      color: #fff;
    }

    .mode-selector input {
      margin: 0;
      accent-color: var(--accent-primary);
    }

    /* Colors */
    .preset-colors {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 10px 0;
    }

    /* HeadNeRF Slider Styling */
    .slider-row {
      margin-bottom: 12px;
    }

    .slider-row label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .slider-row input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--border-secondary);
      outline: none;
    }

    .slider-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent-primary);
      cursor: pointer;
      border: 2px solid #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .slider-row input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent-primary);
      cursor: pointer;
      border: 2px solid #fff;
    }

    .color-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 2px solid var(--border-secondary);
      cursor: pointer;
      transition: transform 0.1s;
    }

    .color-btn:hover {
      transform: scale(1.1);
    }

    .color-btn.selected {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(106, 161, 255, 0.4);
    }

    .selected-colors {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .color-tag {
      font-size: 11px;
      background: var(--bg-quaternary);
      border: 1px solid var(--border-secondary);
      padding: 4px 8px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .remove-color {
      cursor: pointer;
      color: #ff6b6b;
      font-weight: bold;
    }

    /* Custom Image Area */
    .custom-img-area {
      background: var(--bg-quaternary);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--border-secondary);
      margin-top: 10px;
    }

    /* Mobile Responsive */
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .compare {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">FaceLab Hub</div>
      <div class="tag">AI Image Processing v2.0</div>
    </div>

    <div class="grid">
      <div class="card">
        <p class="title">Tools</p>
        <div class="menu">
          <button id="nav-bg" class="active" onclick="switchTool('bg')">
            üñºÔ∏è Background Removal
          </button>
          <button id="nav-single" onclick="switchTool('single')">
            üë§ SimSwap (Single)
          </button>
          <button id="nav-multi" onclick="switchTool('multi')">
            üë• SimSwap (Multi)
          </button>
          <button id="nav-headnerf" onclick="switchTool('headnerf')">
            üß† HeadNeRF
          </button>
        </div>

        <div
          style="margin-top: 30px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px; font-size: 12px; color: var(--text-tertiary);">
          <strong>System Status:</strong><br>
          ‚Ä¢ Gateway: Online<br>
          ‚Ä¢ Services: Ready
        </div>
      </div>

      <div class="card">
        <p class="title" id="current-tool-title">Background Removal</p>

        <div id="panel-bg" class="panel active">
          <div class="box">
            <label>1. Upload Main Image (Subject)</label>
            <input id="bg_input" type="file" accept="image/*" />
            <div id="thumb_bg" class="thumbs"></div>

            <div style="margin-top: 25px;">
              <label>2. Select Output Mode</label>
              <div class="mode-selector">
                <label title="Remove background and save as PNG">
                  <input type="radio" name="bg_mode" value="transparent" />
                  Transparent
                </label>
                <label title="Replace background with solid color(s)">
                  <input type="radio" name="bg_mode" value="color" checked />
                  Solid Color
                </label>
                <label title="Replace background with your own image">
                  <input type="radio" name="bg_mode" value="image" />
                  Custom Image
                </label>
                <label title="Blur the original background">
                  <input type="radio" name="bg_mode" value="blur" />
                  Blur Effect
                </label>
              </div>
            </div>

            <div id="opt-color" style="display: block;">
              <label>Select Colors (Click to add/remove)</label>
              <div class="preset-colors">
                <button class="color-btn" data-c="255,255,255" style="background:#fff" title="White"></button>
                <button class="color-btn" data-c="0,0,0" style="background:#000" title="Black"></button>
                <button class="color-btn" data-c="255,0,0" style="background:#f00"></button>
                <button class="color-btn" data-c="0,255,0" style="background:#0f0"></button>
                <button class="color-btn" data-c="0,0,255" style="background:#00f"></button>
                <button class="color-btn" data-c="255,255,0" style="background:#ff0"></button>
                <button class="color-btn" data-c="0,255,255" style="background:#0ff"></button>
                <button class="color-btn" data-c="255,0,255" style="background:#f0f"></button>
                <input type="color" id="custom-picker"
                  style="height:32px; width:40px; border:none; background:none; cursor:pointer;">
              </div>
              <div id="selected-colors-list" class="selected-colors"></div>
            </div>

            <div id="opt-image" class="custom-img-area" style="display: none;">
              <label>Upload Background Image</label>
              <input id="bg_custom_file" type="file" accept="image/*" />
              <div id="thumb_bg_custom" class="thumbs"></div>
            </div>

            <div id="opt-blur"
              style="display: none; padding: 10px; background: rgba(106,161,255,0.1); border-radius: 6px; font-size: 13px; color: var(--text-highlight);">
              ‚ÑπÔ∏è System will blur the original background while keeping the subject sharp.
            </div>

            <div class="actions">
              <button id="btn-run-bg" class="btn primary">Run Process</button>
              <button onclick="clearBg()" class="btn">Clear</button>
            </div>
            <div id="status-bg" class="status"></div>

            <div id="view-compare-bg" class="compare" style="display:none;">
              <div class="pane">
                <div class="pane-header">Original</div>
                <img id="img-bg-before" />
              </div>
              <div class="pane">
                <div class="pane-header">Result</div>
                <img id="img-bg-after" />
              </div>
            </div>

            <div id="view-grid-bg" class="results-grid" style="display:none;"></div>
          </div>
        </div>

        <div id="panel-single" class="panel">
          <div class="box">
            <div class="row">
              <div>
                <label>Source Face (Identity)</label>
                <input id="src_single" type="file" accept="image/*" />
                <div id="thumb_src_single" class="thumbs"></div>
              </div>
              <div style="margin-top: 15px;">
                <label>Target Image</label>
                <input id="dst_single" type="file" accept="image/*" />
                <div id="thumb_dst_single" class="thumbs"></div>
              </div>
            </div>
            <div class="actions">
              <button id="btn-run-single" class="btn primary">Swap Face</button>
              <button onclick="clearSingle()" class="btn">Clear</button>
            </div>
            <div id="status-single" class="status"></div>

            <div id="view-single" class="compare" style="display:none;">
              <div class="pane">
                <div class="pane-header">Target (Before)</div>
                <img id="img-single-before" />
              </div>
              <div class="pane">
                <div class="pane-header">Result (After)</div>
                <img id="img-single-after" />
              </div>
            </div>
          </div>
        </div>

        <div id="panel-multi" class="panel">
          <div class="box">
            <div class="row">
              <div>
                <label>Source Faces (Select Multiple)</label>
                <input id="src_multi" type="file" accept="image/*" multiple />
                <div style="font-size:11px; color:#aaa; margin-top:4px;">Hold Ctrl/Cmd to select multiple files</div>
                <div id="thumb_src_multi" class="thumbs"></div>
              </div>
              <div style="margin-top: 15px;">
                <label>Target Image</label>
                <input id="dst_multi" type="file" accept="image/*" />
                <div id="thumb_dst_multi" class="thumbs"></div>

                <!-- Face Detection UI -->
                <div style="margin-top: 10px;">
                  <button id="btn-detect" class="btn" style="font-size:12px; padding:6px 12px;">üîç Detect Target Faces
                    (to map)</button>
                </div>
                <div id="mapping-area"
                  style="display:none; margin-top:15px; padding:10px; border:1px dashed #444; border-radius:8px;">
                  <label style="color:#6aa1ff">Face Mapping</label>
                  <div id="detected-faces-list" style="display:flex; flex-wrap:wrap; gap:15px;"></div>
                </div>

              </div>
            </div>
            <div class="actions">
              <button id="btn-run-multi" class="btn primary">Swap Multi Faces</button>
              <button onclick="clearMulti()" class="btn">Clear</button>
            </div>
            <div id="status-multi" class="status"></div>

            <div id="view-multi" class="compare" style="display:none;">
              <div class="pane">
                <div class="pane-header">Target (Before)</div>
                <img id="img-multi-before" />
              </div>
              <div class="pane">
                <div class="pane-header">Result (After)</div>
                <img id="img-multi-after" />
              </div>
            </div>
          </div>
        </div>

        <!-- HeadNeRF Panel -->
        <div id="panel-headnerf" class="panel">
          <div class="box">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

              <!-- Left: Controls -->
              <div>
                <label style="font-size: 14px; color: var(--accent-primary); margin-bottom: 10px; display: block;">üìÅ
                  Source & Target Selection</label>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                  <div>
                    <label>Source Identity</label>
                    <select id="headnerf-source"
                      style="width: 100%; padding: 8px; background: var(--bg-quaternary); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 6px;">
                      <option value="">Loading...</option>
                    </select>
                    <div id="headnerf-source-preview" style="margin-top: 8px; text-align: center;">
                      <img id="headnerf-source-img"
                        style="max-width: 80px; max-height: 80px; border-radius: 6px; border: 1px solid var(--border-secondary);" />
                    </div>
                  </div>
                  <div>
                    <label>Target Identity</label>
                    <select id="headnerf-target"
                      style="width: 100%; padding: 8px; background: var(--bg-quaternary); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 6px;">
                      <option value="">Loading...</option>
                    </select>
                    <div id="headnerf-target-preview" style="margin-top: 8px; text-align: center;">
                      <img id="headnerf-target-img"
                        style="max-width: 80px; max-height: 80px; border-radius: 6px; border: 1px solid var(--border-secondary);" />
                    </div>
                  </div>
                </div>

                <hr style="border: none; border-top: 1px solid var(--border-secondary); margin: 15px 0;">

                <label style="font-size: 14px; color: var(--accent-primary); margin-bottom: 10px; display: block;">üéöÔ∏è
                  Blending Controls <span style="font-size: 11px; color: var(--text-tertiary);">(0 = Source, 1 =
                    Target)</span></label>

                <div class="slider-row">
                  <label>Identity: <span id="val-identity">0.00</span></label>
                  <input type="range" id="headnerf-identity" min="0" max="1" step="0.01" value="0" style="width: 100%;">
                </div>
                <div class="slider-row">
                  <label>Expression: <span id="val-expression">0.00</span></label>
                  <input type="range" id="headnerf-expression" min="0" max="1" step="0.01" value="0"
                    style="width: 100%;">
                </div>
                <div class="slider-row">
                  <label>Albedo: <span id="val-albedo">0.00</span></label>
                  <input type="range" id="headnerf-albedo" min="0" max="1" step="0.01" value="0" style="width: 100%;">
                </div>
                <div class="slider-row">
                  <label>Illumination: <span id="val-illumination">0.00</span></label>
                  <input type="range" id="headnerf-illumination" min="0" max="1" step="0.01" value="0"
                    style="width: 100%;">
                </div>

                <hr style="border: none; border-top: 1px solid var(--border-secondary); margin: 15px 0;">

                <label style="font-size: 14px; color: var(--accent-primary); margin-bottom: 10px; display: block;">üîÑ
                  View Controls</label>

                <div class="slider-row">
                  <label>Pitch (Up/Down): <span id="val-pitch">0.00</span></label>
                  <input type="range" id="headnerf-pitch" min="-1" max="1" step="0.01" value="0" style="width: 100%;">
                </div>
                <div class="slider-row">
                  <label>Yaw (Left/Right): <span id="val-yaw">0.00</span></label>
                  <input type="range" id="headnerf-yaw" min="-1" max="1" step="0.01" value="0" style="width: 100%;">
                </div>
                <div class="slider-row">
                  <label>Roll (Tilt): <span id="val-roll">0.00</span></label>
                  <input type="range" id="headnerf-roll" min="-1" max="1" step="0.01" value="0" style="width: 100%;">
                </div>

                <div class="actions" style="margin-top: 15px;">
                  <button id="btn-reset-headnerf" class="btn">üîÑ Reset All</button>
                </div>
              </div>

              <!-- Right: Output -->
              <div style="text-align: center;">
                <label style="font-size: 14px; color: var(--accent-primary); margin-bottom: 10px; display: block;">üñºÔ∏è
                  Rendered Output</label>
                <div id="headnerf-output-container"
                  style="background: var(--bg-quaternary); border: 1px solid var(--border-secondary); border-radius: 12px; padding: 10px; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                  <img id="headnerf-output" style="max-width: 100%; max-height: 450px; border-radius: 8px;" />
                  <div id="headnerf-loading" style="display: none;">
                    <span class="spinner"></span> Rendering...
                  </div>
                </div>
                <div id="headnerf-status" class="status" style="margin-top: 10px;"></div>
              </div>
            </div>

            <!-- Fitting Section -->
            <hr style="border: none; border-top: 1px solid var(--border-secondary); margin: 25px 0;">

            <div
              style="background: var(--bg-quaternary); border: 2px dashed var(--accent-primary); border-radius: 12px; padding: 20px;">
              <label style="font-size: 16px; color: var(--accent-primary); margin-bottom: 15px; display: block;">üì∑
                Image Fitting - Convert Your Photo to Latent Code</label>

              <p style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 15px;">
                Upload a face photo to convert it into a HeadNeRF latent code. The fitted code can then be used as
                Source or Target for generation.
              </p>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Left: Input -->
                <div>
                  <label>Upload Face Image</label>
                  <input type="file" id="headnerf-fit-input" accept="image/*"
                    style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 6px;">
                  <div id="headnerf-fit-preview" class="thumbs" style="margin-top: 10px;"></div>

                  <div class="actions" style="margin-top: 15px;">
                    <button id="btn-fit-headnerf" class="btn primary">üöÄ Start Fitting</button>
                  </div>

                  <div id="headnerf-fit-status" class="status" style="margin-top: 10px;"></div>
                </div>

                <!-- Right: Result -->
                <div>
                  <label>Fitting Result</label>
                  <div id="headnerf-fit-result-container"
                    style="background: var(--bg-secondary); border: 1px solid var(--border-secondary); border-radius: 8px; padding: 10px; min-height: 200px; display: flex; align-items: center; justify-content: center;">
                    <img id="headnerf-fit-result"
                      style="max-width: 100%; max-height: 250px; border-radius: 6px; display: none;" />
                    <span id="headnerf-fit-placeholder" style="color: var(--text-tertiary); font-size: 12px;">Result
                      will appear here after fitting</span>
                  </div>
                  <div id="headnerf-fit-filename"
                    style="margin-top: 8px; font-size: 12px; color: var(--text-highlight);"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // ===========================================
    // 1. TOOL SWITCHING LOGIC
    // ===========================================
    function switchTool(toolName) {
      // Buttons
      document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
      document.getElementById(`nav-${toolName}`).classList.add('active');

      // Panels
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.getElementById(`panel-${toolName}`).classList.add('active');

      // Title
      const titles = {
        'bg': 'Background Removal',
        'single': 'SimSwap (Single Face)',
        'multi': 'SimSwap (Multi Face)',
        'headnerf': 'HeadNeRF (Real-time Head Generation)'
      };
      document.getElementById('current-tool-title').textContent = titles[toolName];

      // Initialize HeadNeRF when panel is opened
      if (toolName === 'headnerf') {
        initHeadNeRF();
      }
    }

    // Helper: Create Thumbnail
    function showThumb(file, containerId) {
      const box = document.getElementById(containerId);
      box.innerHTML = ''; // clear
      if (!file) return;

      // Support multiple files if array passed
      const files = (file instanceof FileList || Array.isArray(file)) ? file : [file];

      for (let i = 0; i < files.length; i++) {
        let f = files[i];
        const div = document.createElement('div');
        div.className = 'thumb';
        const img = document.createElement('img');
        img.src = URL.createObjectURL(f);
        div.appendChild(img);

        // Add index badge for multi src
        if (containerId === 'thumb_src_multi') {
          const badge = document.createElement('span');
          badge.innerText = i;
          badge.style.position = 'absolute';
          badge.style.background = 'rgba(0,0,0,0.7)';
          badge.style.color = '#fff';
          badge.style.fontSize = '10px';
          badge.style.padding = '2px 5px';
          div.style.position = 'relative';
          div.appendChild(badge);
        }

        box.appendChild(div);
      }
    }

    // ===========================================
    // 2. BACKGROUND REMOVAL LOGIC
    // ===========================================
    const bgInput = document.getElementById('bg_input');
    const bgCustomFile = document.getElementById('bg_custom_file');
    const bgRadios = document.querySelectorAll('input[name="bg_mode"]');
    let selectedColors = [];

    // Thumbnail events
    bgInput.onchange = () => showThumb(bgInput.files[0], 'thumb_bg');
    bgCustomFile.onchange = () => showThumb(bgCustomFile.files[0], 'thumb_bg_custom');

    // Mode Switching
    bgRadios.forEach(r => r.addEventListener('change', () => {
      const mode = r.value;
      document.getElementById('opt-color').style.display = (mode === 'color') ? 'block' : 'none';
      document.getElementById('opt-image').style.display = (mode === 'image') ? 'block' : 'none';
      document.getElementById('opt-blur').style.display = (mode === 'blur') ? 'block' : 'none';
    }));

    // Color Management
    function renderColors() {
      const list = document.getElementById('selected-colors-list');
      list.innerHTML = selectedColors.map(c => `
      <div class="color-tag">
        <span style="width:10px;height:10px;background:rgb(${c});border-radius:50%;border:1px solid #fff;"></span>
        ${c}
        <span class="remove-color" onclick="toggleColor('${c}')">√ó</span>
      </div>
    `).join('');

      // Toggle button state
      document.querySelectorAll('.color-btn').forEach(btn => {
        btn.classList.toggle('selected', selectedColors.includes(btn.dataset.c));
      });
    }

    window.toggleColor = (c) => {
      if (selectedColors.includes(c)) selectedColors = selectedColors.filter(x => x !== c);
      else selectedColors.push(c);
      renderColors();
    };

    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.onclick = () => toggleColor(btn.dataset.c);
    });

    // Custom Color Picker
    document.getElementById('custom-picker').onchange = (e) => {
      const hex = e.target.value;
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      toggleColor(`${r},${g},${b}`);
    };

    // MAIN RUN FUNCTION
    document.getElementById('btn-run-bg').onclick = async () => {
      const mode = document.querySelector('input[name="bg_mode"]:checked').value;
      const status = document.getElementById('status-bg');
      const btn = document.getElementById('btn-run-bg');

      if (!bgInput.files[0]) return alert('Please upload the main image first.');

      // Prepare Data
      const fd = new FormData();
      fd.append('image', bgInput.files[0]);
      fd.append('mode', mode);

      if (mode === 'color') {
        if (selectedColors.length === 0) return alert('Please select at least one color.');
        fd.append('colors', selectedColors.join('|'));
      } else if (mode === 'image') {
        if (!bgCustomFile.files[0]) return alert('Please upload a background image.');
        fd.append('bg_image', bgCustomFile.files[0]);
      }

      // UI Loading
      btn.disabled = true;
      status.innerHTML = '<span class="spinner"></span> Processing...';
      document.getElementById('view-compare-bg').style.display = 'none';
      document.getElementById('view-grid-bg').style.display = 'none';

      try {
        const res = await fetch('/api/background_removal', { method: 'POST', body: fd });
        const data = await res.json();

        if (!res.ok || !data.ok) throw new Error(data.detail || 'API Error');

        status.innerHTML = `<span style="color:#6bff8d">Success!</span>`;

        // Show Original
        document.getElementById('img-bg-before').src = URL.createObjectURL(bgInput.files[0]);

        // Show Results
        if (data.results.length === 1) {
          // Single Result
          document.getElementById('view-compare-bg').style.display = 'flex';
          document.getElementById('img-bg-after').src = data.results[0] + '?t=' + Date.now();
        } else {
          // Grid Result
          const grid = document.getElementById('view-grid-bg');
          grid.style.display = 'grid';
          grid.innerHTML = data.results.map((url, i) => `
          <div class="result-item">
            <img src="${url}?t=${Date.now()}">
            <div class="result-label">Variant ${i + 1}</div>
          </div>
        `).join('');
        }

      } catch (e) {
        status.innerHTML = `<span style="color:#ff6b6b">Error: ${e.message}</span>`;
      } finally {
        btn.disabled = false;
      }
    };

    window.clearBg = () => {
      bgInput.value = ''; bgCustomFile.value = '';
      document.getElementById('thumb_bg').innerHTML = '';
      document.getElementById('thumb_bg_custom').innerHTML = '';
      document.getElementById('status-bg').innerHTML = '';
      document.getElementById('view-compare-bg').style.display = 'none';
      document.getElementById('view-grid-bg').style.display = 'none';
      selectedColors = [];
      renderColors();
    };

    // ===========================================
    // 3. SIMSWAP (SINGLE) LOGIC
    // ===========================================
    const srcSingle = document.getElementById('src_single');
    const dstSingle = document.getElementById('dst_single');

    srcSingle.onchange = () => showThumb(srcSingle.files[0], 'thumb_src_single');
    dstSingle.onchange = () => showThumb(dstSingle.files[0], 'thumb_dst_single');

    document.getElementById('btn-run-single').onclick = async () => {
      if (!srcSingle.files[0] || !dstSingle.files[0]) return alert('Select source and target.');

      const btn = document.getElementById('btn-run-single');
      const st = document.getElementById('status-single');
      btn.disabled = true;
      st.innerHTML = '<span class="spinner"></span> Swapping...';

      const fd = new FormData();
      fd.append('src', srcSingle.files[0]);
      fd.append('dst', dstSingle.files[0]);

      try {
        const res = await fetch('/api/simswap', { method: 'POST', body: fd });
        const data = await res.json();
        if (!data.ok) throw new Error(data.detail);

        st.innerHTML = '<span style="color:#6bff8d">Done!</span>';
        document.getElementById('img-single-before').src = URL.createObjectURL(dstSingle.files[0]);
        document.getElementById('img-single-after').src = data.result_url + '?t=' + Date.now();
        document.getElementById('view-single').style.display = 'flex';
      } catch (e) {
        st.innerHTML = `<span style="color:#ff6b6b">${e.message}</span>`;
      } finally {
        btn.disabled = false;
      }
    };

    window.clearSingle = () => {
      srcSingle.value = ''; dstSingle.value = '';
      document.getElementById('thumb_src_single').innerHTML = '';
      document.getElementById('thumb_dst_single').innerHTML = '';
      document.getElementById('view-single').style.display = 'none';
      document.getElementById('status-single').innerHTML = '';
    };

    // ===========================================
    // 4. SIMSWAP (MULTI) LOGIC
    // ===========================================
    const srcMulti = document.getElementById('src_multi');
    const dstMulti = document.getElementById('dst_multi');

    srcMulti.onchange = () => showThumb(srcMulti.files, 'thumb_src_multi');
    dstMulti.onchange = () => {
      showThumb(dstMulti.files[0], 'thumb_dst_multi');
      document.getElementById('mapping-area').style.display = 'none'; // hide on change
    };

    // Detect Faces Logic
    document.getElementById('btn-detect').onclick = async () => {
      if (!dstMulti.files[0]) return alert("Select target image first");

      const st = document.getElementById('status-multi');
      st.innerHTML = '<span class="spinner"></span> Detecting...';

      const fd = new FormData();
      fd.append('dst', dstMulti.files[0]);

      try {
        const res = await fetch('/api/simswap_multi_detect', { method: 'POST', body: fd });
        const data = await res.json();
        if (!data.ok) throw new Error(data.detail || "Detection failed");

        st.innerHTML = "";
        renderDetectedFaces(data.faces);
      } catch (e) {
        st.innerHTML = `<span style="color:#ff6b6b">${e.message}</span>`;
      }
    };

    function renderDetectedFaces(faces) {
      const container = document.getElementById('mapping-area');
      const list = document.getElementById('detected-faces-list');
      list.innerHTML = "";

      if (faces.length === 0) {
        list.innerHTML = "<div style='color:#ffff00'>No faces detected</div>";
      } else {
        faces.forEach(face => {
          // face = { index: 0, url: '...' }
          const item = document.createElement('div');
          item.style.textAlign = 'center';
          item.innerHTML = `
               <img src="${face.url}" style="width:60px; height:60px; border-radius:8px; object-fit:cover; display:block; margin:0 auto 5px;">
               <div style="font-size:11px; margin-bottom:5px;">Target #${face.index}</div>
               <select class="map-select" data-target="${face.index}" style="padding:2px; font-size:11px; width:70px;">
                  <option value="-1">Auto</option>
                  ${generateSourceOptions()}
               </select>
            `;
          list.appendChild(item);
        });
      }
      container.style.display = 'block';
    }

    function generateSourceOptions() {
      const count = srcMulti.files.length;
      if (count === 0) return "";
      let opts = "";
      for (let i = 0; i < count; i++) {
        opts += `<option value="${i}">Src ${i}</option>`;
      }
      return opts;
    }

    document.getElementById('btn-run-multi').onclick = async () => {
      if (srcMulti.files.length === 0 || !dstMulti.files[0]) return alert('Select sources and target.');

      const btn = document.getElementById('btn-run-multi');
      const st = document.getElementById('status-multi');
      btn.disabled = true;
      st.innerHTML = '<span class="spinner"></span> Swapping Multiple...';

      const fd = new FormData();
      for (let f of srcMulti.files) fd.append('src', f);
      fd.append('dst', dstMulti.files[0]);

      // Collect mapping
      const selects = document.querySelectorAll('.map-select');
      let mapStr = "";
      let mapArr = [];
      selects.forEach(s => {
        if (s.value !== "-1") {
          mapArr.push(`${s.dataset.target}:${s.value}`);
        }
      });
      if (mapArr.length > 0) fd.append('mapping', mapArr.join(','));

      try {
        const res = await fetch('/api/simswap_multi_upload', { method: 'POST', body: fd });
        const data = await res.json();
        if (!data.ok) throw new Error(data.detail);

        st.innerHTML = '<span style="color:#6bff8d">Done!</span>';
        document.getElementById('img-multi-before').src = URL.createObjectURL(dstMulti.files[0]);
        document.getElementById('img-multi-after').src = data.result_url + '?t=' + Date.now();
        document.getElementById('view-multi').style.display = 'flex';
      } catch (e) {
        st.innerHTML = `<span style="color:#ff6b6b">${e.message}</span>`;
      } finally {
        btn.disabled = false;
      }
    };

    window.clearMulti = () => {
      srcMulti.value = ''; dstMulti.value = '';
      document.getElementById('thumb_src_multi').innerHTML = '';
      document.getElementById('thumb_dst_multi').innerHTML = '';
      document.getElementById('view-multi').style.display = 'none';
      document.getElementById('status-multi').innerHTML = '';
      document.getElementById('mapping-area').style.display = 'none';
      document.getElementById('detected-faces-list').innerHTML = '';
    };

    // ===========================================
    // 5. HEADNERF LOGIC
    // ===========================================
    let headnerfInitialized = false;
    let headnerfRenderTimeout = null;
    const HEADNERF_DEBOUNCE_MS = 100; // Debounce for real-time updates

    async function initHeadNeRF() {
      if (headnerfInitialized) return;

      const status = document.getElementById('headnerf-status');
      status.innerHTML = '<span class="spinner"></span> Loading samples...';

      try {
        // Load available samples
        const res = await fetch('/api/headnerf/samples');
        const samples = await res.json();

        if (samples.length === 0) {
          status.innerHTML = '<span style="color:#ff6b6b">No samples found. Please download LatentCodeSamples.</span>';
          return;
        }

        // Populate dropdowns
        const sourceSelect = document.getElementById('headnerf-source');
        const targetSelect = document.getElementById('headnerf-target');

        sourceSelect.innerHTML = samples.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        targetSelect.innerHTML = samples.map(s => `<option value="${s.name}">${s.name}</option>`).join('');

        // Set default selections (first two samples)
        if (samples.length >= 2) {
          sourceSelect.value = samples[0].name;
          targetSelect.value = samples[1].name;
        }

        // Load current state from service
        try {
          const currentRes = await fetch('/api/headnerf/current');
          const current = await currentRes.json();
          if (current.source) sourceSelect.value = current.source;
          if (current.target) targetSelect.value = current.target;
        } catch (e) {
          console.log('Could not get current state, using defaults');
        }

        // Setup event listeners
        setupHeadNeRFListeners();

        // Initial render
        await renderHeadNeRF();

        status.innerHTML = '<span style="color:#6bff8d">Ready! Adjust sliders for real-time preview.</span>';
        headnerfInitialized = true;

      } catch (e) {
        status.innerHTML = `<span style="color:#ff6b6b">Error: ${e.message}. Is HeadNeRF service running on port 8003?</span>`;
      }
    }

    function setupHeadNeRFListeners() {
      const sliders = ['identity', 'expression', 'albedo', 'illumination', 'pitch', 'yaw', 'roll'];

      // Slider real-time updates with debouncing
      sliders.forEach(name => {
        const slider = document.getElementById(`headnerf-${name}`);
        const valSpan = document.getElementById(`val-${name}`);

        slider.oninput = () => {
          valSpan.textContent = parseFloat(slider.value).toFixed(2);
          debouncedRender();
        };
      });

      // Source/Target dropdown changes
      document.getElementById('headnerf-source').onchange = async (e) => {
        const status = document.getElementById('headnerf-status');
        status.innerHTML = '<span class="spinner"></span> Loading source...';

        try {
          const res = await fetch(`/api/headnerf/set_source?sample_name=${e.target.value}`, { method: 'POST' });
          const data = await res.json();

          if (data.preview_base64) {
            document.getElementById('headnerf-source-img').src = `data:image/png;base64,${data.preview_base64}`;
          }

          await renderHeadNeRF();
          status.innerHTML = '<span style="color:#6bff8d">Source updated!</span>';
        } catch (err) {
          status.innerHTML = `<span style="color:#ff6b6b">${err.message}</span>`;
        }
      };

      document.getElementById('headnerf-target').onchange = async (e) => {
        const status = document.getElementById('headnerf-status');
        status.innerHTML = '<span class="spinner"></span> Loading target...';

        try {
          const res = await fetch(`/api/headnerf/set_target?sample_name=${e.target.value}`, { method: 'POST' });
          const data = await res.json();

          if (data.preview_base64) {
            document.getElementById('headnerf-target-img').src = `data:image/png;base64,${data.preview_base64}`;
          }

          await renderHeadNeRF();
          status.innerHTML = '<span style="color:#6bff8d">Target updated!</span>';
        } catch (err) {
          status.innerHTML = `<span style="color:#ff6b6b">${err.message}</span>`;
        }
      };

      // Reset button
      document.getElementById('btn-reset-headnerf').onclick = () => {
        const sliders = ['identity', 'expression', 'albedo', 'illumination', 'pitch', 'yaw', 'roll'];
        sliders.forEach(name => {
          const slider = document.getElementById(`headnerf-${name}`);
          const valSpan = document.getElementById(`val-${name}`);
          slider.value = 0;
          valSpan.textContent = '0.00';
        });
        renderHeadNeRF();
      };
    }

    function debouncedRender() {
      if (headnerfRenderTimeout) {
        clearTimeout(headnerfRenderTimeout);
      }
      headnerfRenderTimeout = setTimeout(() => {
        renderHeadNeRF();
      }, HEADNERF_DEBOUNCE_MS);
    }

    async function renderHeadNeRF() {
      const output = document.getElementById('headnerf-output');
      const loading = document.getElementById('headnerf-loading');

      // Get slider values
      const params = new URLSearchParams({
        identity: document.getElementById('headnerf-identity').value,
        expression: document.getElementById('headnerf-expression').value,
        albedo: document.getElementById('headnerf-albedo').value,
        illumination: document.getElementById('headnerf-illumination').value,
        pitch: document.getElementById('headnerf-pitch').value,
        yaw: document.getElementById('headnerf-yaw').value,
        roll: document.getElementById('headnerf-roll').value
      });

      try {
        const res = await fetch(`/api/headnerf/render?${params}`);
        const data = await res.json();

        if (data.ok && data.image) {
          output.src = `data:image/png;base64,${data.image}`;
          output.style.display = 'block';
          loading.style.display = 'none';
        } else {
          throw new Error(data.error || 'Render failed');
        }
      } catch (e) {
        console.error('HeadNeRF render error:', e);
        document.getElementById('headnerf-status').innerHTML = `<span style="color:#ff6b6b">${e.message}</span>`;
      }
    }

    // ===========================================
    // 6. HEADNERF FITTING LOGIC
    // ===========================================

    // Fit input preview
    document.getElementById('headnerf-fit-input').onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        const preview = document.getElementById('headnerf-fit-preview');
        preview.innerHTML = '';
        const div = document.createElement('div');
        div.className = 'thumb';
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        div.appendChild(img);
        preview.appendChild(div);
      }
    };

    // Fit button click
    document.getElementById('btn-fit-headnerf').onclick = async () => {
      const fileInput = document.getElementById('headnerf-fit-input');
      const status = document.getElementById('headnerf-fit-status');
      const btn = document.getElementById('btn-fit-headnerf');
      const resultImg = document.getElementById('headnerf-fit-result');
      const placeholder = document.getElementById('headnerf-fit-placeholder');
      const filenameDiv = document.getElementById('headnerf-fit-filename');

      if (!fileInput.files[0]) {
        alert('Please upload an image first.');
        return;
      }

      btn.disabled = true;
      status.innerHTML = '<span class="spinner"></span> Processing... This may take 2-5 minutes.';
      resultImg.style.display = 'none';
      placeholder.style.display = 'block';
      filenameDiv.innerHTML = '';

      const fd = new FormData();
      fd.append('image', fileInput.files[0]);

      try {
        const res = await fetch('/api/headnerf/fit', { method: 'POST', body: fd });
        const data = await res.json();

        if (!res.ok || !data.ok) {
          throw new Error(data.detail || data.error || 'Fitting failed');
        }

        status.innerHTML = '<span style="color:#6bff8d">‚úÖ Fitting complete!</span>';

        // Show result image if available
        if (data.result_image) {
          resultImg.src = `data:image/png;base64,${data.result_image}`;
          resultImg.style.display = 'block';
          placeholder.style.display = 'none';
        }

        // Show filename
        if (data.fitted_name) {
          filenameDiv.innerHTML = `<strong>Saved as:</strong> ${data.fitted_name}<br><span style="font-size:11px;">Use "Refresh Sample List" or reload to see it in dropdowns.</span>`;
        }

        // Refresh sample lists
        await refreshHeadNeRFSamples();

      } catch (e) {
        status.innerHTML = `<span style="color:#ff6b6b">‚ùå Error: ${e.message}</span>`;
      } finally {
        btn.disabled = false;
      }
    };

    // Refresh samples function
    async function refreshHeadNeRFSamples() {
      try {
        const res = await fetch('/api/headnerf/samples');
        const samples = await res.json();

        const sourceSelect = document.getElementById('headnerf-source');
        const targetSelect = document.getElementById('headnerf-target');

        const currentSource = sourceSelect.value;
        const currentTarget = targetSelect.value;

        sourceSelect.innerHTML = samples.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        targetSelect.innerHTML = samples.map(s => `<option value="${s.name}">${s.name}</option>`).join('');

        // Restore selection
        if (currentSource) sourceSelect.value = currentSource;
        if (currentTarget) targetSelect.value = currentTarget;

      } catch (e) {
        console.log('Could not refresh samples:', e);
      }
    }

  </script>
</body>

</html>